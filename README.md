# Ormlite SQL In-flight Modification Demo
Demonstration of OrmLite extensions to modify generated SQL before being sent to DB server


Ormlite uses the configured Dialect Provider to create and evaluate `SqlExpression<T>` object.  By overriding the 
creation of these to create a specific sub-class of `SqlExpression<T>`, then overriding  the `ToSelectStatement()`, we can 
modify the SQL generated by OrmLite before it is executed on the DB.

In this scenario, let us imagine we have an organizational hierarchy stored in `Organization`.  Each record in the 
`Organization` table represents some logical group (region, state, sales-footprint, country, etc.), and may belong to
a single parent organization.  A denormalized read-only table `OrganizationDRO` stores every combination of organization, 
itself, and its children.

OrmLite will work as normal until the extension method `.WithOrganization(long?)` is called.  This method specifies
which specific level / subtree that we are querying.  During the `SELECT ...` statement generation, a Microsoft
[TSqlParser](https://learn.microsoft.com/en-us/dotnet/api/microsoft.sqlserver.transactsql.scriptdom.tsql160parser?view=sql-dacfx-161) 
is used to parse the query and find references to named tables.  The named table reference is replaced with 
an automatically generated subquery.

*Note: the subquery currently uses a hardcoded organization value.  Ideally this organization value would use a parameter.

## Output

### Relevant code
``` 
var exp = Db.From<Prescription>().Where(q=>q.Name.Contains("Rx"));
var results1 = Db.Select(exp);
Console.WriteLine(results1.TextDump());
Console.WriteLine("=============================");


var exp2 = exp.WithOrganization(2);
var results2 = Db.Select(exp2);
Console.WriteLine(results2.TextDump());
Console.WriteLine("=============================");
```

### Console results
```
Executing:
SELECT "Id", "Name", "OrganizationId"
FROM "Prescription"
WHERE "Name" like @0

Parameters:
         @0 = %Rx%

| # | Id | Name   | OrganizationId |
|---|----|--------|----------------|
| 1 |  1 | Rx A   |              1 |
| 2 |  2 | Rx B   |              2 |
| 3 |  3 | Rx B-2 |              4 |



=============================
Executing:
SELECT "Id", "Name", "OrganizationId"
FROM (SELECT t.* FROM "Prescription" AS t INNER JOIN OrganizationDRO o ON o.OrganizationId = @OrganizationId AND o.ChildId = t.OrganizationId) AS "Prescription"
WHERE "Name" like @0

Parameters:
         @0 = %Rx%
         OrganizationId = 2

| # | Id | Name   | OrganizationId |
|---|----|--------|----------------|
| 1 |  2 | Rx B   |              2 |
| 2 |  3 | Rx B-2 |              4 |



=============================
```
